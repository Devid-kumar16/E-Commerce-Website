// src/admin/useAdminApi.js
import { useNavigate } from "react-router-dom";
import { useAuth } from './context/AuthProvider';

const API_BASE = "http://localhost:5000/api";

export default function useAdminApi() {
  const { token, logout } = useAuth();
  const navigate = useNavigate();

  return async function api(path, options = {}) {
    const { method = "GET", body = null, headers = {}, skipAuthRedirect = false, signal = undefined } = options;

    // require token for protected endpoints
    if (!token) {
      if (!skipAuthRedirect) {
        try { logout(); } catch (e) {}
        navigate("/login");
      }
      throw new Error("Not authenticated");
    }

    // build headers; if body is FormData, don't set JSON content-type
    const isFormData = typeof FormData !== "undefined" && body instanceof FormData;
    const mergedHeaders = {
      ...(isFormData ? {} : { "Content-Type": "application/json" }),
      Authorization: `Bearer ${token}`,
      ...headers,
    };

    let res;
    try {
      res = await fetch(`${API_BASE}${path}`, {
        method,
        headers: mergedHeaders,
        body: isFormData ? body : body ? JSON.stringify(body) : undefined,
        signal,
      });
    } catch (err) {
      // network-level error (DNS, offline, aborted, CORS, etc.)
      const msg = err && err.name === "AbortError" ? "Request aborted" : "Network error";
      throw new Error(msg);
    }

    // handle unauthorized / forbidden
    if (res.status === 401 || res.status === 403) {
      // allow caller to handle auth errors if requested
      if (!skipAuthRedirect) {
        try { logout(); } catch (e) {}
        navigate("/login");
      }
      // attempt to read message, but still throw
      let payload = {};
      try { payload = await res.json().catch(() => ({})); } catch (e) {}
      throw new Error(payload.message || "Unauthorized");
    }

    // no content
    if (res.status === 204) return {};

    // parse JSON safely
    let data;
    try {
      data = await res.json().catch(() => ({}));
    } catch (err) {
      // parsing error
      throw new Error("Failed to parse response");
    }

    if (!res.ok) {
      throw new Error(data.message || "Request failed");
    }

    return data;
  };
}


